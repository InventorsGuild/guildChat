<!doctype html>
<html>
  <head>
   <link rel="icon" href="/favicon.ico?v3" />
   <link rel="apple-touch-icon-precomposed" sizes="57x57" href="apple-touch-icon-57x57.png" />
   <link rel="apple-touch-icon-precomposed" sizes="114x114" href="apple-touch-icon-114x114.png" />
   <link rel="apple-touch-icon-precomposed" sizes="72x72" href="apple-touch-icon-72x72.png" />
   <link rel="apple-touch-icon-precomposed" sizes="144x144" href="apple-touch-icon-144x144.png" />
   <link rel="apple-touch-icon-precomposed" sizes="60x60" href="apple-touch-icon-60x60.png" />
   <link rel="apple-touch-icon-precomposed" sizes="120x120" href="apple-touch-icon-120x120.png" />
   <link rel="apple-touch-icon-precomposed" sizes="76x76" href="apple-touch-icon-76x76.png" />
   <link rel="apple-touch-icon-precomposed" sizes="152x152" href="apple-touch-icon-152x152.png" />
   <link rel="icon" type="image/png" href="favicon-196x196.png" sizes="196x196" />
   <link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96" />
   <link rel="icon" type="image/png" href="favicon-32x32.png" sizes="32x32" />
   <link rel="icon" type="image/png" href="favicon-16x16.png" sizes="16x16" />
   <link rel="icon" type="image/png" href="favicon-128.png" sizes="128x128" />
   <meta name="application-name" content="&nbsp;"/>
   <meta name="msapplication-TileColor" content="#FFFFFF" />
   <meta name="msapplication-TileImage" content="mstile-144x144.png" />
   <meta name="msapplication-square70x70logo" content="mstile-70x70.png" />
   <meta name="msapplication-square150x150logo" content="mstile-150x150.png" />
   <meta name="msapplication-wide310x150logo" content="mstile-310x150.png" />
   <meta name="msapplication-square310x310logo" content="mstile-310x310.png" />

   <link rel="stylesheet" type="text/css" href="public/xbbcode.css">
   <link rel="stylesheet" href="public/animate.min.css"/>
   <link rel="stylesheet" type="text/css" href="assets/css/style.css"/>

    <title>Chat</title>

  </head>
  <body>
    <div id="typingIndicatorContainer">
	  <ul id="typingIndicator"></ul>
	</div>
	<div id="floodControlContainer">
	  <div id="floodControlBubble">
	    <span id="close">X</span>
	    <span>You're sending messages too fast.  Check your privilege</span>
	  </div>
	</div>
    <div id="container">
	  <div id="shadow"></div>
      <div id="header">
	    <div id="circle"></div>
		<div id="nameBox">
		  <label id="connectText" class="noSelect">Connected as</label>
		  <label id="connectName" class="noSelect">&nbsp;</label>
		</div>
		<ul id="moreUL">
		  <li id="moreLI" class="noSelect">
		    More
			<ul id="dropDown">
			  <div id="moreDropDown">
				 <div id="onlineContainer">
				   <span id="onlineUsersSpan" class="noSelect">Online Users</span>
				   <div id="onlineUsersScrollable">
				     <ul id="onlineUsers"></ul>
				   </div>
				 </div>
				<button id="settingsButton">Settings</button>
			  </div>
			</ul>
		  </li>
		</ul>
	  </div>

	  <div id="settingsBox">
	    <div id="settingsContainer">
		   <div id="settingsHeader">
		     <label id="settingsLabel" class="noSelect">Settings</label>
		   </div>
		   <div id="nameChangeContainer">
		     <span id="displayNameSpan" class="noSelect">Display Name</span>
		     <input id="changeNameInput" autofocus autocomplete="off" />
		   </div>
		   <div id="colorContainer">

		     <div id="colorNameChangeContainer" class="colorChangeContainer">
		       <div id="colorNameSpanInput" class="colorSpanInput">
			     <span id="colorChangeNameSpan" class="noSelect">Name Color</span>
			     <span class="hex">#</span><input id="colorChangeNameInput" class="colorChangeInput" maxlength="6" autocomplete="off" />
			   </div>
			   <div id="colorNamePreview" class="colorPreview"></div>
			 </div>

		     <div id="colorTextChangeContainer" class="colorChangeContainer">
		       <div id="colorTextSpanInput" class="colorSpanInput">
			     <span id="colorChangeTextSpan" class="noSelect">Text Color</span>
			     <span class="hex">#</span><input id="colorChangeTextInput" class="colorChangeInput" maxlength="6" autocomplete="off" />
			   </div>
			   <div id="colorTextPreview" class="colorPreview"></div>
			 </div>

		   </div>
           <button id="changeAllSettingsButton" class="regularButton">Apply</button>
		</div>
	  </div>


	  <div id="portrait"></div>


      <div id="messageFormContainer">
      <form id="messageForm" action="">
        <input id="messageInput" autofocus autocomplete="off" /><button id="sendButton">Send</button>
		<div id="autoScrollInputContainer">
		  <label id="autoScrollInputLabel">Scroll</label>
		  <input id="autoScrollInput" type="checkbox" checked>
		</div>
      </form>
	  </div>
	</div>
	<div id="messagesContainer">
      <ul id="messages"></ul>
	</div>


	<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
	<script src="http://code.jquery.com/jquery-1.11.1.js"></script>
	<script src="public/xbbcode.js"></script>
	<script src="public/Autolinker.min.js"></script>
	<script type="text/javascript" language="javascript">

		var socket = io();
		var clicks = 0;
		var darken = false;
	    var name = "";
		var messagesContainer = document.getElementById('messagesContainer');
		var connected = false;
		var nameColor = "414163";
		var textColor = "000000";
		var isTyping = false;

		var unreadMessages = 0;
		var activeWindow = true;

		var floodControlOn = false;

		var imgDarken = false;
		var shrunkenImg = false;
		var isZoomed = false;
		//var imgSel = null;

		var autolinker = new Autolinker({
			replaceFn : function(autolinker, match) {
				if(match.getType() == 'url') {
					var tempUrl = match.getUrl();
					var fileEx = tempUrl.substr(tempUrl.lastIndexOf('.')+1);

					//Auto for image links
					if(['jpg','png','gif','bmp','jpeg'].indexOf(fileEx) > -1) {
						var bStr = XBBCODE.process({
							text: '[img]'+tempUrl+'[/img]',
							removeMisalignedTags: false,
							addInLineBreaks: false
						});
						return bStr.html;
					}
					else
						return true;
				}
			}
		});

		//When you submit a message
		$('#messageForm').submit(function() {
		    //console.log(parseInt($('#typingIndicatorContainer').css('margin-bottom')) + 10);
			if(($('#messageInput').val() != '') && (connected)) {
			    var guid = getCookie('guid');
				//var fixedStr = stopScriptInjecting($('#messageInput').val());

				var bbStr = XBBCODE.process({
					text: $('#messageInput').val(),
					removeMisalignedTags: false,
					addInLineBreaks: false
				});

				var embedStr = autoEmbedYouTube(bbStr.html);
				//var messageStr = linkify(embedStr);
				var messageStr = autolinker.link(embedStr);

				//var messageStr = linkify(bbStr.html);

				socket.emit('chat message', '<li class="msg"><label style="color:#'+nameColor+'">' + name + ':</label><span style="color:#'+textColor+'">' + messageStr + '</span></li>', guid);
				//$('#messages').append($('<li class="msg">').append('<label style="color:#'+nameColor+'">' + name + ':</label><span style="color:#'+textColor+'">' + messageStr + '</span>'));
				$('#messageInput').val('');
				if($('#autoScrollInput').prop('checked'))
				    messagesContainer.scrollTop = messagesContainer.scrollHeight;
				socket.emit('is typing', "no", guid);
			}
			return false;
		});
/*
		function linkify(str) {
		    var reg = /(([a-z]+:\/\/)?(([a-z0-9\-]+\.)+([a-z]{2}|aero|arpa|biz|com|coop|edu|gov|info|int|jobs|mil|museum|name|nato|net|org|pro|travel|local|internal))(:[0-9]{1,5})?(\/[a-z0-9_\-\.~]+)*(\/([a-z0-9_\-\.]*)(\?[a-z0-9+_\-\.%=&amp;]*)?)?(#[a-zA-Z0-9!$&'()*+.=-_~:@/?]*)?)(\s+|$)/gi

			return str.replace(reg, function(url) {
				if(url.substring(0,4) == 'http')
			        return '<a href="' + url + '" target="_blank">' + url + '</a>';
				else
				    return '<a href="http://' + url + '" target="_blank">' + url + '</a>';
			});
		}

		function stopScriptInjecting(str) {
			return str.replace(/</g, "&lt;").replace(/>/g, "&gt;");
		}
*/
		function autoEmbedYouTube(str) {
		    var reg = /(https?:\/\/)?(?:www\.)?youtu(?:be\.com\/watch\?v=|\.be\/)([\w\-\_]*)(&(amp;)?[\w\?‌​=]*)?/;
			var match = str.match(reg);

			if(match && match[2].length == 11) {
				return str.replace(reg, function(url) {
				    return '//www.youtube.com/embed/' + match[2];
				});
			}
			else
			    return str;
		}

		//For adjusting the height and width of a video player
		$(document).on('mouseup', '.videoContainer', function(event) {
			if ( $(event.target).closest('.resizer').length > 0 ) {
				var res = $(this).find('.resizer');
				//Enlarge
				if($(res).data('zoom') == '+') {
					$(this).css('width', '560px');
					$(this).css('height', '345px');
					$(res).siblings('.yt').css('width', '560px');
					$(res).siblings('.yt').css('height', '345px');
					$(res).css('background-image', 'url("-.png")');
					$(res).data('zoom', '-');
				}
				else {	//Shrink
					$(this).css('width', '325px');
					$(this).css('height', '200px');
					$(res).siblings('.yt').css('width', '325px');
					$(res).siblings('.yt').css('height', '200px');
					$(res).css('background-image', 'url("+.png")');
					$(res).data('zoom', '+');
				}
			}
		});

		//Close the flood control message (called from either a click or 4s delay from visible)
		function closeFloodBubble() {
			if(floodControlOn) {
				floodControlOn = false;
				$('#floodControlBubble').addClass('animated fadeOutDown');
				$('#floodControlBubble').one('webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend', function() {
					$('#floodControlBubble').removeClass();
					$('#floodControlContainer').css('visibility', 'hidden');
				});
			}
		}
		//Close the flood control message when you click it
		$('#floodControlBubble').click(function() {
			closeFloodBubble();

		});

	    //Toggle the dropdown menu to display the online users/settings button
	    $('#moreLI').click(function() {
	        $('#dropDown').toggle();
	    });

	    //Open the settings box
	    $('#settingsButton').click(function() {
   	        $('#shadow').toggle();
            $('#settingsBox').toggle();
			$('#changeNameInput').focus();
			$('#changeNameInput').val(name);
			$('#colorChangeNameInput').val(nameColor);
			$('#colorNamePreview').css('background', '#' + nameColor);
			$('#colorChangeTextInput').val(textColor);
			$('#colorTextPreview').css('background', '#' + textColor);
			clicks = 0;
			darken = true;
		});

	    //Perform the steps to fully change your name if you changed it
	    function changeName() {
			var tempName = $('#changeNameInput').val();
			if(tempName != "") {
			    name = tempName;
				setCookie("name", name, 1);
				if(connected) {
					var guid = getCookie('guid');
				    $('#connectName').text(name);
				    socket.emit('new display name', name, guid);
				}
			}
		}

		//Check to see if it's a hex color
		function isHexColor(color) {
		   return /(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i.test(color);
		}

		//Perform the steps to fully change a color if you changed it
		function changeColor(choice){
			var tempColor;
			if(choice == "Name")
		        tempColor = $('#colorChangeNameInput').val();
		    else
			    tempColor = $('#colorChangeTextInput').val();

			if(isHexColor("#" + tempColor)) {
			    if(choice == "Name") {
				    nameColor = tempColor;
					setCookie("nameColor", nameColor, 1);
				}
				else {
				    textColor = tempColor;
					setCookie("textColor", textColor, 1);
					$('#messageInput').css('color', '#'+textColor);
				}
			}
		}

	    //Dynamically change the preview for the name color as you type valid hex colors
		$('#colorChangeNameInput').on('input', function() {
		    if(isHexColor("#" + $(this).val()))
			    $('#colorNamePreview').css('background', '#' + $(this).val());
		});
		//Dynamically change the preview for the text color as you type valid hex colors
		$('#colorChangeTextInput').on('input', function() {
		    if(isHexColor("#" + $(this).val()))
			    $('#colorTextPreview').css('background', '#' + $(this).val());
		});

	    //When you change some settings and click Apply
		$('#changeAllSettingsButton').click(function() {
			changeName();
			changeColor("Name");
			changeColor("Text");
			$('#shadow').toggle();
			$('#settingsBox').toggle();
			$('#messageInput').focus();
			darken = false;

		});

		//Allows you to press enter on the change name box and it will click Apply
		$('#changeNameInput').keypress(function(e) {
			if(e.which == 13)
				$('#changeAllSettingsButton').click();
		});
		//Allows you to press enter on the change name color box and it will click Apply
		$('#colorChangeNameInput').keypress(function(e) {
			if(e.which == 13)
				$('#changeAllSettingsButton').click();
		});
		//Allows you to press enter on the change text color box and it will click Apply
		$('#colorChangeTextInput').keypress(function(e) {
			if(e.which == 13)
				$('#changeAllSettingsButton').click();
		});

		function endImageAnimation() {
			$('#portrait').one('webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend', function() {
			    $('#portrait').removeClass('animated fadeOut');
				$('#portrait').css('visibility', 'hidden');
			});
		}

	    //Remove the shadow when you click anywhere besides the settingsBox/click anywhere when portrait is up
	    $(document).on('click', function(event) {
			if(!$(event.target).closest('#settingsBox').length) {
				clicks++;
				if((clicks > 1) && (darken == true)) {
					$('#shadow').toggle();
					$('#settingsBox').toggle();
					$('#messageInput').focus();
					darken = false;
					clicks = 0;
				}
			}
			if(imgDarken) {
				//If it's an image that fits normally, close it regardless if you click
				if(!shrunkenImg) {
					//Allow right clicking on the image though
					if(event.which != 3) {
						clicks++;
						if(clicks > 2) {
							//$(imgSel).css('opacity', '1');
							//imgSel = null;
							//$('#portrait').addClass('animated fadeOut');
							//endImageAnimation();
							$('#shadow').toggle();
							$('#portrait').css('visibility', 'hidden');
							//$('#portrait').toggle();
							$('#messageInput').focus();
							clicks = 0;
							imgDarken = false;
						}
					}
				}
				//For bigger-than-your-browser images
				else {
					//If you click outside the image, close it
					if(!$(event.target).closest('#portrait img').length) {
						clicks++;
						if(clicks > 2) {
							//$('#portrait').addClass('animated fadeOut');
							//endImageAnimation();

							//Remove excess scrollbars if you closed it when it was zoomed in
							if(isZoomed) {
								$('#portrait img').css('max-height', $(window).height()-10+'px');   //94%   //90%	 83%
								$('#portrait img').css('max-width', $(window).width()-10+'px');
								height = $('#portrait img')[0].clientHeight;
								$('#portrait').css('margin-top', '-'+(height/2)+'px');
							}
							$('#shadow').toggle();
							$('#portrait').css('visibility', 'hidden');
							//$('#portrait').toggle();
							$('#messageInput').focus();
							imgDarken = false;
							clicks = 0;
							shrunkenImg = false;
						}
					}
					//If you click the image, zoom in/out
					else {
						var height;
						//Zoom back out
						if(isZoomed) {
							$('#portrait img').css('max-height', $(window).height()-20+'px');   //94%   //90%	 83%
							$('#portrait img').css('max-width', $(window).width()-20+'px');
							height = $('#portrait img')[0].clientHeight;
							$('#portrait').css('margin-top', '-'+(height/2)+'px');
							isZoomed = false;
							$('#portrait img').css('cursor', 'zoom-in');
						}
						//Zoom to natural size
						else {
							$('#portrait img').css('max-height', '');
							$('#portrait img').css('max-width', '');
							height = $('#portrait img')[0].naturalHeight;
							isZoomed = true;
							$('#portrait img').css('cursor', 'zoom-out');
						}
					}
				}
			}
		});

		//For when a user is typing text/deleted all text (fire off typing identifier)
		$('#messageInput').on('input', function() {
			if(connected) {
				var guid = getCookie('guid');
				if($(this).val().length > 0) {
					if(!isTyping) {
						isTyping = true;
						socket.emit('is typing', "yes", guid);
					}
				}
				else {
					isTyping = false;
					socket.emit('is typing', "no", guid);
				}
			}
		});

		//Display the clicked image in its full size
		$(document).on('click', '.img', function() {
			$('#portrait').empty();
			$('#portrait').append(($(this).children('img').eq(0)).clone());
			$('#portrait img').removeAttr('style');
			var height = $('#portrait img')[0].naturalHeight;
			var width = $('#portrait img')[0].naturalWidth;
			$('#shadow').toggle();
			$('#portrait').css('visibility', 'visible');

			$('#portrait img').css('max-height', $(window).height()-20+'px');   //94%   //90%	 83%
			$('#portrait img').css('max-width', $(window).width()-20+'px');
			//imgSel = this;
			//$(this).css('opacity', '0.1');
			var height2 = $('#portrait img')[0].clientHeight;
			var width2 = $('#portrait img')[0].clientWidth;

			$('#portrait').addClass('animated fadeIn');
			//$('#portrait').toggle();


			//If it's too big for the screen, still shrink it
			if((height > height2) || (width > width2)) {
			    $('#portrait').css('margin-top', '-'+(height2/2)+'px');
				shrunkenImg = true;
				$('#portrait img').css('cursor', 'zoom-in');
			}
			else
			    $('#portrait').css('margin-top', '-'+(height/2)+'px');

		    imgDarken = true;
			clicks = 0;

			$('#portrait').one('webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend', function() {
			     $('#portrait').removeClass('animated fadeIn');
			});

		});

		//Get the values for the name and text colors from cookies
		function getColors() {
		    var tempNameCol = getCookie("nameColor");
			var tempTextCol = getCookie("textColor");

			if(tempNameCol != "")
			    nameColor = tempNameCol;
			if(tempTextCol != "") {
			    textColor = tempTextCol;
				$('#messageInput').css('color', '#'+textColor);
			}
		}

		//On page ready, set up name variable and connected users
		$( document ).ready(function() {
			var guid = getCookie('guid');
			console.log(guid);
			if(guid == '') {
			    guid = setGUID();
				//setCookie('guid', guid, 1);
				document.cookie = 'guid='+guid+'; path=/';
			}
		    $('#connectText').text('Not connected');
			$('#connectName').text('____');
			getColors();
		});

		function setGUID() {
		    function s4() {
				return Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1);
			}

			var id = s4() + s4() + '-' + s4() + '-' + s4() + '-' + s4() + '-' + s4() + s4() + s4();
			return id;
		}

	  	//Handle the events needed for when you make connection with the server
		function connectionStart() {
		    $('#circle').css('background', '#00e500');
			$('#circle').css('border', '2px solid #00b200');
			//Glow
			$('#circle').css('-webkit-box-shadow', '0 0 7px #0F0');
			$('#circle').css('-moz-box-shadow', '0 0 7px #0F0');
			$('#circle').css('box-shadow', '0 0 7px #0F0');

		    $('#connectText').text('Connected as');
			var tempName = getCookie("name");

			var guid = getCookie('guid');

			if(tempName != "") {
				name = tempName;
				socket.emit('have display name', name, guid);
				$('#connectName').text(name);
				socket.emit('need all connections', "pls");
				socket.emit('need last messages', 'pls');
			}
			else
				socket.emit('need guest name', guid);
		}

		//Handle the events for if the server goes down
		function serverDisconnect() {
		    $('#circle').css('background', '#E60000');
			$('#circle').css('border', '2px solid #B20000');
			//Glow
			$('#circle').css('-webkit-box-shadow', '0 0 7px #F00');
			$('#circle').css('-moz-box-shadow', '0 0 7px #F00');
			$('#circle').css('box-shadow', '0 0 7px #F00');

		    $('#connectText').text('Not connected');
			$('#connectName').text('____');
			$('#typingIndicator').empty();
			$('#onlineUsers').empty();
		}

		//Remove a specific [user] is typing li
		function removeIndividualTypingIndicator(user) {
		   	$('#typingIndicator li').each(function(index) {
			    if($(this).attr("data-id") == user.ID) {
				    $(this).remove();
				}
			});
		}

		function fadeUnreadMessageBorders() {
		    //jQuery.fn.reverse = [].reverse;

		    //$('.unread').reverse().each(function(i) {
			//	//console.log($(this).text());
			//    $(this).css('border-left-color', 'transparent');
			//});

			//for(var i=0; i<
			var unreadMsgArray = $('.unread');
			var iterations = unreadMsgArray.length;

			if(iterations > 0) {
				function fade(i) {
					setTimeout(function(){
						$(unreadMsgArray[i]).css('border-left-color', 'transparent');
						i++;
						if(i<iterations)
							fade(i);
					}, 250);
				}
				fade(0);
			}
		}

		//Check if the window is active or not
		window.onfocus = function() {
			activeWindow = true;
			unreadMessages = 0;
			document.title = 'Chat';
			//fadeUnreadMessageBorders();  /////////////////////////////////////////////////////////////// ANIMATION
			getColors();  ///In case something changed if you have two tabs open
		}
		window.onblur = function() { activeWindow = false; }


		//Add the correct HTML to the timestamp
		var monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sept', 'Aug', 'Oct', 'Nov', 'Dec'];
		function setTimestamp(timestampEle) {
		    var date = new Date($(timestampEle).data('time'));
			var day = date.getDate();
			var monthI = date.getMonth();
			var month = monthNames[monthI];
			var year = date.getFullYear();
			var hour = date.getHours();
			var min = date.getMinutes();
			var amPM = "AM";

			if(hour >= 12) {
			    hour -= 12;
				amPM = "PM";
			}
			if(hour == 0)
			    hour = 12;
			if(min < 10)
			   min = '0'+min;

			$(timestampEle).html('&nbsp;&nbsp;&nbsp;&nbsp;<span class="yest">Yesterday&nbsp;</span><span class="month">' + month +
								 '&nbsp;</span><span class="day">' + day + '</span><span class="year">,&nbsp;' + year +
								 '&nbsp;</span><span class="hour">' + hour + ':</span><span class="min">' + min +
								 '&nbsp;</span><span class="amPM">' + amPM + '</span>');
		}

		//Toggle the correct elements in the timestamp
		function formatTimestamp(timestampEle) {
			var now = new Date();

		    var date = new Date($(timestampEle).data('time'));
			var day = date.getDate();
			var monthI = date.getMonth();
			var month = monthNames[monthI];
			var year = date.getFullYear();
			//var hours = date.getHours();
			//var mins = date.getMinutes();

			//Check if it's the same year
			if(year == now.getFullYear()) {
				$(timestampEle).find('.year').hide();
				//Check if it's the same month
			    if(monthI == now.getMonth()) {
					//Check if it's the same day
				    if(day == now.getDate()) {
						$(timestampEle).find('.month').hide();
						$(timestampEle).find('.day').hide();
						$(timestampEle).find('.yest').hide();
					}
					//Check if it's yesterday
					else if(day+1 == now.getDate()) {
						$(timestampEle).find('.month').hide();
						$(timestampEle).find('.day').hide();
						$(timestampEle).find('.yest').show();
					}
					else {
						$(timestampEle).find('.month').show();
						$(timestampEle).find('.day').show();
						$(timestampEle).find('.yest').hide();
					}
				}
				else {
					$(timestampEle).find('.month').show();
					$(timestampEle).find('.day').show();
					$(timestampEle).find('.yest').hide();
				}
			}
			else {
			    $(timestampEle).find('.year').show();
				$(timestampEle).find('.month').show();
				$(timestampEle).find('.day').show();
				$(timestampEle).find('.yest').hide();
			}
		}

		//Fade the timestamp after a length of time
		function fadeTimestamp(timestampEle, length) {
		    setTimeout(function(ele) {
			    $(ele).css('opacity', '0');
			}, length, timestampEle);
		}

		$(document).on('mouseenter', '.msg', function() {
		    formatTimestamp($(this).find('.timestamp'));
		    $(this).find('.timestamp').css('opacity', '0.4');
		});
		$(document).on('mouseleave', '.msg', function() {
		    $(this).find('.timestamp').css('opacity', '0');
		});

		//------------Handle all socket identifiers ---------------------------------------------------
		//For handling the startup of a connection to the server
		socket.on('connect', function() {
		   connected = true;
		   connectionStart();
		});

		//For handling the server disconnecting
		socket.on('disconnect', function() {
			connected = false;
			serverDisconnect();
		});

		//For gathering chat messages and displaying them
		socket.on('chat message', function(msg) {
			$('#messages').append(msg);
			setTimestamp($('.msg').last().find('.timestamp'));
			formatTimestamp($('.msg').last().find('.timestamp'));

			if($('#autoScrollInput').prop('checked'))
			    messagesContainer.scrollTop = messagesContainer.scrollHeight;

			//Notifications in the title
			if(!activeWindow) {
				document.title = '[' + ++unreadMessages + '] Chat';
				//$('#messages li:last-child').addClass('unread');      ///////////////////////ANIMATION
			}

			fadeTimestamp($('.msg').last().find('.timestamp'), 20000);			//////////////////////////////////////FADE
		});

		//For telling the user you're send messages too fast
		socket.on('dropped message', function(msg) {
			floodControlOn = true;
			$('#floodControlContainer').css('visibility', 'visible');
			$('#floodControlBubble').addClass('animated fadeInUp');

			$('#floodControlBubble').one('webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend', function() {
		        $('#floodControlBubble').removeClass();
			    $('#floodControlContainer').css('visibility', 'visible');
				setTimeout(closeFloodBubble, 4000);
		    });

		});

		//For setting your name as a guest with a unique number (you haven't configured a name yet)
		socket.on('guest name', function(gName) {
			name = gName;
			setCookie('name', name, '');
			$('#connectName').text(name);
			socket.emit('need all connections', "pls");
			socket.emit('need last messages', 'pls');
		});

		//For getting newly connected users and appending their name to the online users list
		socket.on('connected user', function(name) {
			$('#onlineUsers').append($('<li>').text(name));
			$('#messages').append('<label class="userLabel">' + name + ' has connected<br></label>');
			if($('#autoScrollInput').prop('checked'))
			    messagesContainer.scrollTop = messagesContainer.scrollHeight;
		});

		//For getting all the connected users at once to append to the online users list
		socket.on('all connections', function(names) {
			$('#onlineUsers').empty();
			for(var i=0; i<names.length; i++) {
				$('#onlineUsers').append($('<li>').text(names[i].Name));
			}
		});

	    //For displaying to the chat when a user disconnects
		socket.on('disconnected user', function(user) {
			removeIndividualTypingIndicator(user);
			$('#messages').append('<label class="userLabel">' + user.Name + ' has disconnected<br></label>');
			if($('#autoScrollInput').prop('checked'))
			    messagesContainer.scrollTop = messagesContainer.scrollHeight;
		});

		//For displaying to the chat when a user is typing
		socket.on('typing', function(user) {
		    $('#typingIndicator').append('<li class="noSelect" data-typing="yes" data-name="'+user.Name+'" data-id="'+user.ID+'">' + user.Name + ' is typing</li>');
		});

		//For removing '[user] is typing' li
		socket.on('not typing', function(user) {
		    removeIndividualTypingIndicator(user);
		});

		//For if you change names in one active chat tab/window and you need to update the other(s)
		socket.on('you changed names', function(tempName) {
			name = tempName;
		    $('#connectName').text(name);
		});

		//For displaying the last messages that are stored on the server
		socket.on('last messages', function(lastMessages, index, size) {
			var i;
		    if(lastMessages.length == size)
			    i=index;
			else
			    i=0;

		    for(var j=0; j<lastMessages.length; j++) {
			    $('#messages').append(lastMessages[i]);
				setTimestamp($('.msg').last().find('.timestamp'));
				formatTimestamp($('.msg').last().find('.timestamp'));
				fadeTimestamp($('.msg').last().find('.timestamp'), 8000);			//////////////////////////////////////FADE
				i=(i+1)%size
			}

			if($('#autoScrollInput').prop('checked'))
				messagesContainer.scrollTop = messagesContainer.scrollHeight;
		});
		//---------------------------------------------------------------------------------------------

		//Functions for cookies for storing your name  ------------------------------------------------
		function setCookie(cname, cvalue, exdays) {
			var d = new Date();
			d.setTime(d.getTime() + (exdays*24*60*60*1000));
			var expires = "expires="+d.toUTCString();
			document.cookie = cname + "=" + cvalue + "; " + expires;
		}

		function getCookie(cname) {
			var tname = cname + "=";
			var ca = document.cookie.split(';');
			for(var i=0; i<ca.length; i++) {
				var c = ca[i];
				while (c.charAt(0)==' ') c = c.substring(1);
				if (c.indexOf(tname) == 0) return c.substring(tname.length, c.length);
			}
			return "";
		}
		//---------------------------------------------------------------------------------------------
	</script>
  </body>
</html>
